---
title: "analysis"
format: html
editor: visual
---

## Known Issues

-   Spain, Polish, and 1997 US additional data sets in the original data set are exclusively women
-   2nd spanish dataset also has overwhelming majority of women

## Solved

Added a missing by design level to the Netherlands and Hungary

-   Hungary gets deleted because it's missing a nativity indicator - should add a category missing by design, so does a whole survey in the Netherlands

Just threw out the BHPS, too much of a headache

-   The UK has a bunch of 0 weight observations - these are extension statistics for (1500 Scotland and Wales, 2000 Northern Ireland) - these should be thrown out, they are for making separate analyses of those countries, the original sample is nationally representative
-   UK BHPS and German surveys have a lot of missing values on education
    -   UK BHPS had very sparse education records

    -   UK BHPS also has patchy start dates of first unions

    -   I think I will just get rid of them from the analysis, seeing as I've got GGS for them now

## Initial setup

```{r library}
# General functionality
library(tidyverse)
library(flextable)
library(officer)

# For importing the data
library(sjmisc)
library(haven)
library(janitor)
library(countrycode)

# model evaluation
library(broom)
library(marginaleffects)
library(sandwich)
library(lmtest)

# possible speeding up models
library(speedglm)

# meta-regression
library(metafor)

# MAAS from speedglm messes with this
select <- dplyr::select
```

```{r issue-button}
# countries with missing ISLEDs
analysis_select |> filter(is.na(isled)) |> group_by(country, round, isled) |> summarise(n = n_distinct(respid)) |> print(n=500)

# countries with missing foreign_born
analysis_select |> filter(is.na(foreign_born)) |> group_by(country, round, foreign_born) |> summarise(n = n_distinct(respid)) |> print(n=500)

```

## Preparation

Consider whether you want to do winsorization - add it in for the article, not the thesis

```{r weights}
# Define parameters
winsor_factor <- 3
max_iterations <- 15

# Start the pipe
analysis_weights <- analysis_select %>% 
  # Tag one observation per respondent
  group_by(country, round, respid) %>%
  mutate(oneobs = row_number() == 1) %>%
  ungroup()

# Iterative winsorization and rescaling
for (i in 1:max_iterations) {
  analysis_weights <- analysis_weights %>%
    group_by(country, round) %>%
    mutate(
      median_weight = median(perswgt[oneobs], na.rm = TRUE),
      perswgt = if_else(
        oneobs & !is.na(perswgt) & perswgt > winsor_factor * median_weight,
        winsor_factor * median_weight,
        perswgt
      ),
      mean_weight = mean(perswgt[oneobs], na.rm = TRUE),
      perswgt = if_else(
        oneobs & !is.na(perswgt),
        perswgt / mean_weight,
        perswgt
      )
    ) %>%
    select(-median_weight, -mean_weight) %>%
    ungroup()
}

# Spread corrected weights to all person-observations
analysis_weights <- analysis_weights %>%
  group_by(country, round, respid) %>%
  arrange(desc(oneobs)) %>%
  mutate(perswgt = first(perswgt)) %>%  # Simply replace all with first
  ungroup() %>%
  select(-oneobs) %>% 
  arrange(country, round, respid) |> 
  mutate(naive_perswgt = if_else(is.na(perswgt), 1, perswgt))
```

## Creation of country-cohorts and analytical sample

```{r country-cohorts}
analysis_proper <- analysis_weights |>
  
  # add model covariates
  drop_na(isled, time, enrol_mod, foreign_born, male, in_union) |>
  
  # Creation of country-cohorts and standardisation of ISLED (across contexts)
  mutate(
  marriage_cohort_cat = cut(
    marriage_cohort,
    breaks = c(-Inf, seq(1951, 2011, by = 10), Inf),
    labels = c("Before 1951", "1951-1960", "1961-1970", 
               "1971-1980", "1981-1990", "1991-2000", 
               "2001-2010", "After 2010"),
    right = FALSE,
    include.lowest = TRUE
  ),
  
  # Manually combine small cohorts by country
  marriage_cohort_cat = case_when(
    # Austria: combine After 2010 with 2001-2010
    country == "Austria" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # Belarus: combine After 2010 with 2001-2010
    country == "Belarus" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    country == "Kazakhstan" & marriage_cohort_cat %in% c("1961-1970", "1971-1980") ~ "Before 1981",
    
    # Belgium: combine 2001-2010 with After 2010, then with 1991-2000
    country == "Belgium" & marriage_cohort_cat %in% c("1951-1960", "1961-1970") ~ "Before 1971",
    country == "Belgium" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Bulgaria: combine 2001-2010 with After 2010, then with 1991-2000
    country == "Bulgaria" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Canada: perfect prediction after 2010
    country == "Canada" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2001",
    
    # Croatia: combine all before 1991 into one group, and After 2000 with 1991-2000
    country == "Croatia" & marriage_cohort_cat %in% c("Before 1951", "1951-1960", "1961-1970", "1971-1980", "1981-1990") ~ "Before 1991",
    country == "Croatia" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Czechia: combine After 2010 with 2001-2010
    country == "Czechia" & marriage_cohort_cat %in% c("2001-2010", "After 2010", "After 2020") ~ "After 2000",
    
    # Denmark: combine After 2010 with 2001-2010
    country == "Denmark" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # Estonia: combine After 2010 with 2001-2010
    country == "Estonia" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # Finland: combine all before 1991 into one group, and After 2000 with 1991-2000
    country == "Finland" & marriage_cohort_cat %in% c("Before 1951", "1951-1960", "1961-1970", "1971-1980", "1981-1990") ~ "Before 1991",
    country == "Finland" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # France: combine all 1991 onwards
    country == "France" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Georgia: combine After 2000 with 1991-2000
    country == "Georgia" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    country == "Georgia" & marriage_cohort_cat %in% c("1951-1960", "1961-1970") ~ "Before 1971",
    
    # Germany: combine After 2010 with 2001-2010
    country == "Germany" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # Italy: combine all from 1991 onwards
    country == "Italy" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Kazakhstan: combine After 2010 with 2001-2010
    country == "Kazakhstan" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    country == "Kazakhstan" & marriage_cohort_cat %in% c("1961-1970", "1971-1980") ~ "Before 1981",
    
    # Lithuania: combine After 2000 with 1991-2000
    country == "Lithuania" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Moldova
    country == "Moldova" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # Netherlands:
    country == "Netherlands" & marriage_cohort_cat %in% c("1991-2000", "2001-2010") ~ "After 1990",
    
    # Norway: combine After 2010 with 2001-2010
    country == "Norway" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # Poland
    country == "Poland" & marriage_cohort_cat %in% c("1951-1960", "1961-1970") ~ "Before 1971",
    
    # Romania: combine all from 1991 onwards
    country == "Romania" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Russia: combine all from 1991 onwards
    country == "Russia" & marriage_cohort_cat %in% c("1991-2000", "2001-2010", "After 2010") ~ "After 1990",
    
    # Spain: combine After 2010 with 2001-2010
    country == "Spain" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    country == "Spain" & marriage_cohort_cat %in% c("1951-1960", "1961-1970") ~ "Before 1971",
    
    # Sweden:
    country == "Sweden" & marriage_cohort_cat %in% c("1991-2000", "2001-2010") ~ "After 1990",
    
    # United Kingdom: combine After 2010 with 2001-2010
    country == "United Kingdom" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # United States:
    country == "United States" & marriage_cohort_cat %in% c("1991-2000", "2001-2010") ~ "After 1990",
    
    # Uruguay: combine After 2010 with 2001-2010
    country == "Uruguay" & marriage_cohort_cat %in% c("2001-2010", "After 2010") ~ "After 2000",
    
    # Keep all others as-is
    TRUE ~ as.character(marriage_cohort_cat)
  ),
    
    country_cohort = paste0(country, "_", marriage_cohort_cat),
    
    # between country standardisation
    isled_standard = scale(isled)[,1]
  )
```

Country cohorts in need of being joined up

```{r}
analysis_proper |> group_by(country_cohort) |> count(event) |> filter(n<101)
```

## Add macrodata

-   Please run the macrodata file now.

## Connecting macro-indicators to country-cohorts

```{r scoring-country-cohorts}
macro_weighted <- analysis_proper |> 
  group_by(country, country_cohort, obs_year) |> 
  
  # number of Rs observed each year
  summarise(
    pweight = sum(naive_perswgt),
    .groups = "drop"
  ) |> 
  
  group_by(country_cohort) |> 
  
  # total years observed within each country-cohort
  mutate(
    totpweight = sum(pweight),
    oweight = pweight/totpweight, # percentage of union_years observed in each period
    cumweight = cumsum(oweight) # cumulative share of union_years observed
  ) |> 
  ungroup() |>
  dplyr::select(-pweight, -totpweight) |>
   
  
  # add the interpolated macrodata (onto each year)
  left_join(macro_indicators_interpolated |> rename(obs_year = time), by = c("country", "obs_year")) |> 
  
  group_by(country_cohort) |>
  
  # share of union years covered by each time series (e. g. 65% of union years experienced when the time series ends, and 35% of union were experienced by the time it began so in total the time series covers 30% of all union years experienced in a country-cohort - that being it's weight in the calculation then)
  mutate(
    across(
      .cols = where(is.numeric) & !any_of(c("obs_year", "oweight", "cumweight")),
      .fns = ~if(all(is.na(.))) 0 else 
              max(cumweight[!is.na(.)], na.rm = TRUE) - 
              min(cumweight[!is.na(.)], na.rm = TRUE),
      .names = "cov_{.col}"
    )
  ) |>
  ungroup() |>
  
  # aggregating the macro-level indicators for each country-cohort, weighted mean (years experienced by more respondents count for more)
  group_by(country, country_cohort) |>
  summarise(
    across(
      where(is.numeric) & !c(oweight, cumweight),
      ~if(startsWith(cur_column(), "cov_")) first(.) else weighted.mean(., oweight, na.rm = TRUE)
    ),
    .groups = "drop"
  )
```

## Descriptives

## Modelling micro-level

```{r models-micro}
# Model 1: Education + intercept
m1_speed <- speedglm(event ~ isled_standard,
          data = analysis_proper,
          family = binomial(link = "logit"),
          weights = naive_perswgt)

# Model 2: Education + intercept by context (country-cohort)
m2_speed <- speedglm(event ~ isled_standard + country_cohort - 1,
          data = analysis_proper,
          family = binomial(link = "logit"),
          weights = naive_perswgt)

# Model 3: Education + intercept by context + controls
m3_speed <- speedglm(event ~ isled_standard + time + I(time^2) + male + in_union + enrol_mod + foreign_born + country_cohort - 1,
          data = analysis_proper,
          family = binomial(link = "logit"),
          weights = naive_perswgt)

# Model 4: Education Ã— context + intercept by context + controls
m4_speed <- speedglm(event ~ isled_standard:country_cohort + time + I(time^2) + male + in_union +  enrol_mod + foreign_born + country_cohort - 1,
          data = analysis_proper,
          family = binomial(link = "logit"),
          weights = naive_perswgt)
```

## AMEs

```{r speed-AME}
# Calculating AMEs with just 20 percent of the sample (otherwise it takes ages)
set.seed(48103)

analysis_sample <- analysis_proper |> 
  group_by(country_cohort) |> 
  slice_sample(prop = 0.2, weight_by = naive_perswgt, replace = FALSE) |> 
  ungroup()

ames_provisional <- 
  slopes(
    m4_speed,
    variables = "isled_standard",
    by = "country_cohort",
    newdata = analysis_sample
  ) |> 
  tidy() |> 
  rename(ame = estimate, se_ame = std.error) |> 
  
  # add baseline marriage rates
  left_join(
    analysis_proper |> 
      group_by(country_cohort) |> 
      summarise(baseline_mar = weighted.mean(event, naive_perswgt, na.rm = TRUE)),
    by = "country_cohort"
  ) |> 
  
  mutate(
    rescaled_ame = (100 * ame) / baseline_mar,
    rescaled_se = (100 * se_ame) / baseline_mar,
    rescaled_conf.low = (100 * conf.low) / baseline_mar,
    rescaled_conf.high = (100 * conf.high) / baseline_mar
  ) 
  
modelling <- ames_provisional |> 
  separate(country_cohort, 
           into = c("country", "cohort"), 
           sep = "_", 
           remove = FALSE) |> 
  select(country_cohort, country, cohort, starts_with("rescaled"), ame) |> 
  
  # add average marriage year by country-cohort
  left_join(
    analysis_proper|>
      group_by(respid) |>
      filter(row_number() == 1) |>
      ungroup() |> 
      group_by(country_cohort) |> 
      summarise(avg_birth_cohort = weighted.mean(year, naive_perswgt, na.rm = TRUE)),
    by = "country_cohort"
  )  |> 
  
  # add macro-covariates
  left_join(
    macro_weighted |> select(country_cohort, educ_earnings_advantage, educ_unemployment_advantage, relative_lfp, cov_educ_unemployment_advantage, cov_educ_earnings_advantage, cov_relative_lfp),
    by = "country_cohort"
  )
  
  
```

## Margins plot

```{r margins-plot}
modelling <- modelling |> 
  mutate(region = countrycode(country, "country.name", "region23"))  |>  
  mutate(region = case_when(
    country == "United Kingdom" ~ "Western Europe",
    country == "United States" ~ "Western Europe",
    country == "Canada" ~ "Western Europe",
    country == "Estonia" ~ "Eastern Europe",
    country == "Lithuania" ~ "Eastern Europe",
    TRUE ~ region
  )) |> 
  mutate(region = case_when(
    region == "Eastern Europe" ~ "Central and Eastern Europe",
    region == "Western Europe" ~ "Western Europe and North America",
    region == "Western Asia" ~ "Central and Eastern Europe",
    region == "Central Asia" ~ "Central and Eastern Europe",
    region == "South America" ~ "Southern Europe",
    region == "Southern Europe" ~ "Southern Europe and South America",
    TRUE ~ region
  ))

plots_by_region <- modelling |> 
  group_split(region) |>
  map(~ {
    region_name <- unique(.x$region)
    
    ggplot(.x, aes(x = avg_birth_cohort, y = rescaled_ame)) +
      geom_line() +
      geom_point() +
      geom_hline(yintercept = 0, linetype = "solid", color = "grey50", linewidth = 1, alpha = 0.2) +
      scale_x_continuous(breaks = seq(1960, 2020, 10)) +
      facet_wrap(vars(country)) +
      labs(
        title = region_name,
        y = "Effect of education on marriage (pp)",
        x = "Birth cohort (avg. year of 15th birthday in cohort)"
      ) +
      theme_bw() +
      theme(panel.grid = element_blank())
  })

# Assign names based on the region (if not already named)
if (is.null(names(plots_by_region))) {
  names(plots_by_region) <- map_chr(plots_by_region, ~ unique(.x$data$region))
}

# Save each plot in the list
# Alternative using imap
imap(plots_by_region, ~ ggsave(
  filename = paste0(output_plots, "/", gsub(" ", "_", .y), ".png"),
  plot = .x,
  width = 10,
  height = 5.625,
  dpi = 300
))
```
